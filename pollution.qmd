---
title: "pollution"
format: html
---

```{r}
library(tidyverse)
library(lubridate)
theme_set(theme_classic())
```

[Data Link](https://portal.edirepository.org/nis/metadataviewer?packageid=knb-lter-msp.11.1)

Dataset description: Urban lakes are heavily impacted by human activities and climate variability, and they provide many ecosystem services to residents. The MSP LTER program is studying long term changes in urban lake water quality, ecology and management as part of our long term studies of urban environments. The goal of this dataset is to understand how land-use change, management, and climate have impacted urban lake biogeochemistry over time. This dataset includes parameters characterizing the long term (\> 5 years) surface water quality and chemistry of 294 lakes and ponds in the Minneapolis-Saint Paul Seven County Metropolitan Area, Minnesota, USA

```{r}
lakes <- read_csv(here::here('data', "Timeseries_v6_forEDI.csv")) |> 
  mutate(year = year(sampleDate))
```

```{r}
lakes_wide <- lakes |> 
  pivot_wider(names_from = parameter, values_from = result)
```

```{r}
lakes_nonzero <- lakes |> 
  filter(result > 0)
```

```{r}
lakes_recent <- lakes |> 
  mutate(year = year(sampleDate)) |> 
  filter(year >= 2000)
```

```{r}
stats <- lakes |> 
  group_by(parameter) |> 
  summarise(obs_count = n(),
            min = min(result),
            median = median(result),
            mean = mean(result),
            max = max(result),
            sd = sd(result))
```

```{r}
ggplot(lakes, aes(parameter, result)) +
  geom_boxplot() +
  coord_flip()
```

**Model thoughts:**

-   Using a Gamma distribution seems like the best choice for pollution concentrations as a response.

    -   Right skewed data, positive continuous data

**State hypothesis**

-   On average, pollution concentrations in urban Minnesota lakes, increase over time, by year.

**Model in statistical notation**

$$Concentration \sim Gamma(\alpha, \sigma) \\ \log(\mu) = \beta_0 + \beta_1 * Time$$

-   Response Family: Gamma

-   Link Function: log()

-   Predictor: Time

-   $H_0$: $\beta_1$ \<= 0

-   $H_1$: $\beta_1$ \> 0

In Gamma distributions...

- Mean = $\alpha * \beta$

- Variance = $\alpha * \beta^2$

where alpha is the shape parameter and beta is the scale parameter.

```{r}
# Plot timeseries for all parameters
ggplot(lakes, aes(sampleDate, result)) +
  geom_line() +
  facet_wrap(~parameter, scales = "free_y")
```

```{r}
ggplot(lakes_nonzero, aes(county, result)) +
  geom_jitter(aes(color = county))
```

## Fit model using simulated data

```{r}
# Plot chlorine histogram of real data
ggplot(lakes_wide, aes(Cl.mg_L)) +
  geom_histogram()

# Create simulated year data
years <- 1980:2024
n_years <- length(years)

# Define parameters
shape_values <- seq(1, 8, length.out = n_years)
scale <- 1

sim_data <- data.frame(
  year = years,
  sim_chlorine = sapply(shape_values, function(shape) {
    rgamma(1, shape = shape, scale = scale)
  })
)

# Visualize
ggplot(sim_data, aes(sim_chlorine)) +
  geom_histogram()
ggplot(sim_data, aes(year, sim_chlorine)) +
  geom_point()

# Fit model to simulated data
sim_model <- glm(sim_chlorine ~ year, data = sim_data, family = Gamma(link = "log"))
```

## Fit model to real data

```{r}
real_model <- glm(Cl.mg_L ~ year, data = lakes_wide, family = Gamma(link = "log"))
```

