---
title: "pollution"
format: html
---

```{r}
library(tidyverse)
library(lubridate)
theme_set(theme_classic())
```

[Data Link](https://portal.edirepository.org/nis/metadataviewer?packageid=knb-lter-msp.11.1)

Dataset description: Urban lakes are heavily impacted by human activities and climate variability, and they provide many ecosystem services to residents. The MSP LTER program is studying long term changes in urban lake water quality, ecology and management as part of our long term studies of urban environments. The goal of this dataset is to understand how land-use change, management, and climate have impacted urban lake biogeochemistry over time. This dataset includes parameters characterizing the long term (\> 5 years) surface water quality and chemistry of 294 lakes and ponds in the Minneapolis-Saint Paul Seven County Metropolitan Area, Minnesota, USA

```{r}
lakes <- read_csv(here::here('data', "Timeseries_v6_forEDI.csv"))
```

```{r}
lakes_wide <- lakes |> 
  pivot_wider(names_from = parameter, values_from = result)
```


```{r}
stats <- lakes |> 
  group_by(parameter) |> 
  summarise(obs_count = n(),
            min = min(result),
            median = median(result),
            mean = mean(result),
            max = max(result),
            sd = sd(result))
```

```{r}
ggplot(lakes, aes(parameter, result)) +
  geom_boxplot() +
  coord_flip()
```

```{r}
lakes |> filter(parameter == "secchi.m") |> ggplot() + geom_line(aes(sampleDate, result))
```

**Model thoughts:**

-   Using a Gamma distribution seems like the best choice for pollution concentrations as a response.

    -   Right skewed data, positive continuous data

**State hypothesis**

-   There is a relationship between total phosphorus (response) and secchi depth as turbidity measurement (predictor).

**Model in statistical notation**

$$TPConcentration \sim Gamma(\mu, \phi) \\ \log(\mu)? = \beta_0 + \beta_1 * SecchiDepth$$

-   Response Family: Gamma

-   Link Function: ?

-   Predictor: Secchi Disk Depth

-   $H_0$: $\beta_1 = 0$

-   $H_1$: $\beta_1 \neq 0$


$$CV = \frac{\sigma}{\mu} \rightarrow \sigma = CV * \mu = \sqrt{\phi} \rightarrow \sigma^2 = (CV * \mu)^2 = \phi$$
where $\sigma$ is standard deviation and $\phi$ is variance.


## Fit model to simulated data

```{r}
# Define parameters
n_lakes <- 500

mu_pred <- 3
phi_pred <- 3

mu_resp <- 150
cv_resp <- 0.2

# Create independent predictor as Gamma variable
test_pred <- rgamma(n = n_lakes, shape = (mu_pred^2 / phi_pred), scale = (phi_pred / mu_pred))

# Create relationship
response_mean <- mu_resp + 6 * test_pred
# Ensure variance scales with mean
phi_resp <- (cv_resp * response_mean)^2

test_resp <- rgamma(n = n_lakes, shape = (response_mean^2 / phi_resp), scale = (phi_resp / response_mean))

test_df <- data.frame(test_pred, test_resp)

ggplot(test_df, aes(test_pred, test_resp)) +
  geom_point()

test_model <- glm(test_resp ~ test_pred, data = test_df, family = Gamma(link = 'identity'))

# Estimated shape
shape_est <- 1/summary(test_model)$dispersion
# Estimated scale
scale_est <- as.numeric(coef(test_model)[1]) / shape_est

hist(test_df$test_pred, breaks = 30, freq = FALSE)
curve(dgamma(x, shape = (mu_pred^2 / phi_pred), scale = (phi_pred / mu_pred)),
      col = "red", add = TRUE)


hist(test_df$test_resp, breaks = 30, freq = FALSE)
curve(dgamma(x, shape = shape_est, scale = scale_est), col = "red", add = TRUE)
```

## Fit model to real data

```{r}
real_model <- glm(TP.mg_L ~ secchi.m, data = lakes_wide, family = Gamma(link = "log"))
# Raw scatter plot
ggplot(lakes_wide, aes(secchi.m, TP.mg_L)) + geom_point(alpha = 0.1)

hist(lakes_wide$TP.mg_L, breaks = 50)

# Interpreting coefficient for secchi.m
# Must exponentiate to undo link
exp(coef(real_model)[2])
exp(coef(real_model)[1])
```

In response space, the coefficient for secchi.m (beta1) is about 0.70. Meaning, for every 1 meter increase of Secchi depth (clearer waters), total phosphorus (TP) decreases by 30% (multiplied by 0.70). The intercept coefficient (beta0) represents TP when Secchi is 0 meters. Undo-ing the link, this value is estimated at 0.12 mg/L.

```{r}
# Create prediction grid (one predictor for now)
pred_grid <- tibble(secchi.m = seq(min(lakes_wide$secchi.m, na.rm = TRUE), 
                                    max(lakes_wide$secchi.m, na.rm = TRUE), 
                                    length.out = 100))

# Generate predictions
pred_grid <- pred_grid |> 
  mutate(pred_TP = predict(real_model, newdata = pred_grid, type = "response"))

# Plot
ggplot() + 
  geom_point(data = lakes_wide, aes(secchi.m, TP.mg_L), alpha = 0.3) +
  geom_line(data = pred_grid, aes(secchi.m, pred_TP), color = 'red', linewidth = 1)
```

